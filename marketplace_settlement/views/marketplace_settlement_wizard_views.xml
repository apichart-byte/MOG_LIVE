<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Wizard form -->
    <record id="view_marketplace_settlement_wizard_form" model="ir.ui.view">
        <field name="name">marketplace.settlement.wizard.form</field>
        <field name="model">marketplace.settlement.wizard</field>
        <field name="arch" type="xml">
            <form string="Marketplace Settlement">
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Settlement Reference (Auto-generated)"/>
                        </h1>
                    </div>
                    
                    <!-- Profile Selection -->
                    <div class="alert alert-info" role="alert" style="margin: 10px 0;">
                        <div class="row">
                            <div class="col-md-8">
                                <strong>üí° Quick Setup:</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Profile ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Marketplace | 
                                <span invisible="not profile_id">‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ: <strong><field name="profile_id" readonly="1" nolabel="1"/></strong></span>
                                <span invisible="profile_id">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Profile</span>
                            </div>
                            <div class="col-md-4 text-right">
                                <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏´‡∏°‡πà:</strong> ‡πÅ‡∏¢‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° ‚Üí ‡∏•‡∏î‡∏†‡∏≤‡∏©‡∏µ WHT ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°
                            </div>
                        </div>
                    </div>
                    
                    <group string="Profile &amp; Basic Settings">
                        <group>
                            <field name="profile_id" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Profile ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Marketplace..." 
                                   options="{'no_create_edit': True, 'no_open': True}"
                                   class="oe_highlight" string="Marketplace Profile"/>
                            <field name="marketplace_partner_id" options="{'no_create_edit': False}" 
                                   placeholder="‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ Shopee/Lazada" string="Marketplace Partner"/>
                        </group>
                        <group>
                            <field name="date" string="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Settlement"/>
                            <field name="trade_channel" string="‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢"/>
                        </group>
                    </group>
                    
                    <!-- Settlement Configuration -->
                    <group string="Settlement Configuration">
                        <group>
                            <field name="journal_id" options="{'no_create_edit': True}" string="Journal"/>
                            <field name="settlement_account_id" string="Settlement Account"/>
                        </group>
                        <group>
                            <field name="auto_filter" widget="boolean_toggle" string="Auto Filter Invoices"/>
                            <field name="date_from" invisible="not auto_filter" string="From Date"/>
                            <field name="date_to" invisible="not auto_filter" string="To Date"/>
                        </group>
                    </group>
                    
                    <!-- New Workflow Guidance -->
                    <div class="alert alert-info" role="alert" style="margin: 10px 0;">
                        <div class="row">
                            <div class="col-md-12">
                                <strong>üîÑ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà:</strong>
                                <span class="badge badge-primary">1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Settlement</span> ‚Üí
                                <span class="badge badge-info">2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Vendor Bills</span> ‚Üí
                                <span class="badge badge-warning">3. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á Bills</span> ‚Üí
                                <span class="badge badge-success">4. ‡∏´‡∏±‡∏Å‡∏Å‡∏•‡∏ö AR/AP</span> ‚Üí
                                <span class="badge badge-dark">5. ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</span>
                                | <i class="fa fa-check-circle text-success"></i> <strong>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</strong> ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡∏ã‡∏∑‡πâ‡∏≠ + WHT ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Section -->
                    <div class="alert alert-success" role="alert" style="margin: 10px 0;">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h4><field name="invoice_count" readonly="1" nolabel="1"/></h4>
                                <small>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Invoice</small>
                            </div>
                            <div class="col-md-3">
                                <h4><field name="total_amount" readonly="1" nolabel="1"/></h4>
                                <small>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</small>
                            </div>
                            <div class="col-md-3">
                                <h4><field name="net_settlement_amount" readonly="1" nolabel="1"/></h4>
                                <small>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)</small>
                            </div>
                            <div class="col-md-3">
                                <i class="fa fa-check-circle fa-2x text-success"></i>
                                <small>‡∏û‡∏£‡πâ‡∏≠‡∏° Settlement</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settlement Posting Options -->
                    <div class="alert alert-warning" role="alert" style="margin: 10px 0;">
                        <div class="row">
                            <div class="col-md-4">
                                <field name="auto_post_settlement" widget="boolean_toggle" string="Post ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"/>
                            </div>
                            <div class="col-md-4 text-center">
                                <span invisible="auto_post_settlement">
                                    <i class="fa fa-edit text-info"></i> <strong>Draft Mode:</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô Post
                                </span>
                                <span invisible="not auto_post_settlement">
                                    <i class="fa fa-flash text-warning"></i> <strong>Auto Post:</strong> Post ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
                                </span>
                            </div>
                            <div class="col-md-4 text-right">
                                <i class="fa fa-lightbulb-o text-success"></i> <strong>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô Post
                            </div>
                        </div>
                    </div>
                    
                    <notebook>
                        <page string="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Invoices" name="invoices">
                            <div class="row" style="margin-bottom: 10px;">
                                <div class="col-md-3">
                                    <button name="action_refresh_invoices" type="object" class="btn btn-primary" icon="fa-refresh" string="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä"/>
                                </div>
                                <div class="col-md-9">
                                    <div class="alert alert-info" role="alert" style="margin: 0; padding: 10px;">
                                        <span class="badge badge-info"><field name="invoice_count" readonly="1" nolabel="1"/> ‡πÉ‡∏ö</span>
                                        <span class="badge badge-success">‡∏£‡∏ß‡∏° <field name="total_amount" readonly="1" nolabel="1"/> ‡∏ö‡∏≤‡∏ó</span>
                                        <span class="pull-right"><i class="fa fa-info-circle"></i> ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Trade Channel ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                                    </div>
                                </div>
                            </div>
                            <field name="invoice_ids" nolabel="1">
                                <tree decoration-info="is_refund" decoration-bf="amount_residual &gt; 1000" decoration-muted="state == 'cancel'">
                                    <field name="name" string="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà Invoice"/>
                                    <field name="partner_id" string="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"/>
                                    <field name="invoice_date" string="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"/>
                                    <field name="trade_channel" string="‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á"/>
                                    <field name="amount_total" string="‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°" sum="‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"/>
                                    <field name="amount_residual" string="‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠" sum="‡∏£‡∏ß‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠"/>
                                    <field name="move_type" invisible="1"/>
                                    <field name="is_refund" widget="boolean" string="‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"/>
                                    <field name="state" string="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <footer>
                    <button string="Create Settlement" type="object" name="action_create" class="btn-primary" invisible="invoice_count == 0"/>
                    <button string="Cancel" class="btn-default" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Wizard action -->
    <record id="action_marketplace_settlement_wizard" model="ir.actions.act_window">
        <field name="name">Marketplace Settlement</field>
        <field name="res_model">marketplace.settlement.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <!-- Menu under Accounting -->
    <menuitem id="menu_marketplace_settlement_root" name="Marketplace" parent="account.menu_finance" sequence="90"/>
    <record id="action_marketplace_settlement" model="ir.actions.act_window">
        <field name="name">Marketplace Settlements</field>
        <field name="res_model">marketplace.settlement</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'search_default_filter_posted': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first marketplace settlement!
            </p>
            <p>
                Use marketplace settlements to group customer invoices by trade channel
                and create a single receivable entry to the marketplace platform.
            </p>
            <p>
                This is useful for platforms like Shopee, Lazada, TikTok where customers
                pay the platform and the platform pays you periodically.
            </p>
        </field>
    </record>

    <!-- Container menu for marketplace settlement -->
    <menuitem id="menu_marketplace_settlement" name="Marketplace Settlement" parent="menu_marketplace_settlement_root"/>
    <!-- Submenu: view recorded settlements -->
    <menuitem id="menu_marketplace_settlement_records" name="Settlement Records" parent="menu_marketplace_settlement" action="action_marketplace_settlement"/>
    <!-- Submenu: create a new settlement (wizard) -->
    <menuitem id="menu_marketplace_settlement_wizard_action" name="Create Settlement" parent="menu_marketplace_settlement" action="action_marketplace_settlement_wizard"/>

    <!-- Search view for marketplace settlements -->
    <record id="view_marketplace_settlement_search" model="ir.ui.view">
        <field name="name">marketplace.settlement.search</field>
        <field name="model">marketplace.settlement</field>
        <field name="arch" type="xml">
            <search>
                <field name="name" string="Settlement Reference"/>
                <field name="marketplace_partner_id"/>
                <field name="trade_channel"/>
                <field name="date"/>
                <filter name="filter_draft" string="Draft" domain="[('state', '=', 'draft')]"/>
                <filter name="filter_posted" string="Posted" domain="[('state', '=', 'posted')]"/>
                <filter name="filter_reversed" string="Reversed" domain="[('state', '=', 'reversed')]"/>
                <separator/>
                <filter name="filter_netted" string="AR/AP Netted" domain="[('is_netted', '=', True)]"/>
                <filter name="filter_not_netted" string="Not Netted" domain="[('is_netted', '=', False)]"/>
                <filter name="filter_can_net" string="Can Perform Netting" domain="[('can_perform_netting', '=', True)]"/>
                <separator/>
                <filter name="filter_shopee" string="Shopee" domain="[('trade_channel', '=', 'shopee')]"/>
                <filter name="filter_lazada" string="Lazada" domain="[('trade_channel', '=', 'lazada')]"/>
                <filter name="filter_tiktok" string="TikTok" domain="[('trade_channel', '=', 'tiktok')]"/>
                <separator/>
                <filter name="filter_today" string="Today" domain="[('date', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter name="filter_this_month" string="This Month" domain="[('date', '&gt;=', context_today().replace(day=1)), ('date', '&lt;=', (context_today().replace(day=1) + relativedelta(months=1) - relativedelta(days=1)))]"/>
                <group expand="0" string="Group By">
                    <filter name="group_by_trade_channel" string="Trade Channel" context="{'group_by': 'trade_channel'}"/>
                    <filter name="group_by_marketplace" string="Marketplace Partner" context="{'group_by': 'marketplace_partner_id'}"/>
                    <filter name="group_by_state" string="State" context="{'group_by': 'state'}"/>
                    <filter name="group_by_date" string="Date" context="{'group_by': 'date:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- List and form views for marketplace.settlement -->
    <record id="view_marketplace_settlement_tree" model="ir.ui.view">
        <field name="name">marketplace.settlement.tree</field>
        <field name="model">marketplace.settlement</field>
        <field name="arch" type="xml">
            <tree decoration-success="state=='posted'" decoration-muted="state=='draft'" decoration-danger="state=='reversed'" decoration-bf="is_netted">
                <field name="name"/>
                <field name="trade_channel"/>
                <field name="marketplace_partner_id"/>
                <field name="journal_id"/>
                <field name="date"/>
                <field name="invoice_count"/>
                <field name="vendor_bill_count"/>
                <field name="net_settlement_amount"/>
                <field name="net_payout_amount" invisible="vendor_bill_count == 0"/>
                <field name="is_netted" widget="boolean"/>
                <field name="state" widget="badge" decoration-success="state=='posted'" decoration-muted="state=='draft'" decoration-danger="state=='reversed'"/>
                <field name="move_id"/>
                <field name="netting_move_id"/>
            </tree>
        </field>
    </record>

    <record id="view_marketplace_settlement_form" model="ir.ui.view">
        <field name="name">marketplace.settlement.form</field>
        <field name="model">marketplace.settlement</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_preview_settlement" type="object" string="Preview Settlement" class="btn-secondary" 
                            invisible="move_id != False or not can_modify"/>
                    <button name="action_create_settlement" type="object" string="Create Settlement" class="btn-primary" 
                            invisible="move_id != False or not can_modify"
                            groups="account.group_account_user"/>
                    <button name="action_open_netting_wizard" type="object" string="Setup AR/AP Netting" class="oe_highlight" 
                            invisible="not can_perform_netting" 
                            groups="account.group_account_user"/>
                    <button name="action_netoff_ar_ap" type="object" string="Quick Net-off" class="btn-secondary" 
                            invisible="not can_perform_netting or vendor_bill_count == 0" 
                            confirm="This will automatically reconcile customer receivables against available vendor payables. Continue?"
                            groups="account.group_account_user"/>
                    <button name="action_reverse_netting" type="object" string="Reverse Netting" class="btn-secondary" 
                            invisible="not is_netted" 
                            confirm="Are you sure you want to reverse the AR/AP netting?"
                            groups="account.group_account_user"/>
                    <button name="action_reverse_settlement" type="object" string="Reverse Settlement" class="btn-secondary" 
                            invisible="state != 'posted'" confirm="Are you sure you want to reverse this settlement? This will create a reverse journal entry and clear the settlement link."
                            groups="account.group_account_user"/>
                    <button name="action_generate_fee_allocations" type="object" string="Generate Fee Allocations" class="btn-secondary" 
                            invisible="state != 'posted' or has_fee_allocations"/>
                    <button name="action_import_fee_allocations_csv" type="object" string="Import CSV" class="btn-secondary" 
                            invisible="state != 'posted'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,posted,reversed"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_invoices" type="object" class="oe_stat_button" icon="fa-file-text-o">
                            <field name="invoice_count" widget="statinfo" string="Invoices"/>
                        </button>
                        <button name="action_view_vendor_bills" type="object" class="oe_stat_button" icon="fa-file-o" 
                                invisible="vendor_bill_count == 0">
                            <field name="vendor_bill_count" widget="statinfo" string="Vendor Bills"/>
                        </button>
                        <button name="action_link_vendor_bills" type="object" class="oe_stat_button" icon="fa-link" 
                                invisible="state != 'draft'">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Link</span>
                                <span class="o_stat_text">Bills</span>
                            </div>
                        </button>
                        <button name="action_netoff_ap_ar_preview" type="object" class="oe_stat_button" icon="fa-calculator" 
                                invisible="not can_perform_netting or vendor_bill_count == 0">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Net-off</span>
                                <span class="o_stat_text">Preview</span>
                            </div>
                        </button>
                        <button name="action_view_settlement_move" type="object" class="oe_stat_button" icon="fa-book" invisible="move_id == False">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Settlement</span>
                                <span class="o_stat_text">Move</span>
                            </div>
                        </button>
                        <button name="action_view_netting_move" type="object" class="oe_stat_button" icon="fa-exchange" 
                                invisible="netting_move_id == False">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Netting</span>
                                <span class="o_stat_text">Move</span>
                            </div>
                        </button>
                        <button name="action_view_wht_certificates" type="object" class="oe_stat_button" icon="fa-file-text" 
                                invisible="not is_thai_localization_available or wht_cert_count == 0">
                            <field name="wht_cert_count" widget="statinfo" string="WHT Certs"/>
                        </button>
                        <button name="action_view_fee_allocations" type="object" class="oe_stat_button" icon="fa-pie-chart" 
                                invisible="fee_allocation_count == 0">
                            <field name="fee_allocation_count" widget="statinfo" string="Fee Allocations"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="profile_id" readonly="state == 'posted'" 
                                   options="{'no_create_edit': True}"
                                   help="Profile used to create this settlement"/>
                            <field name="trade_channel" readonly="not can_modify"/>
                            <field name="marketplace_partner_id" readonly="not can_modify"/>
                            <field name="journal_id" readonly="not can_modify"/>
                            <field name="date" readonly="not can_modify"/>
                        </group>
                        <group>
                            <field name="move_id"/>
                            <field name="netting_move_id" readonly="1"/>
                            <field name="invoice_count" invisible="1"/>
                            <field name="vendor_bill_count" invisible="1"/>
                            <field name="settlement_account_id" readonly="not can_modify"/>
                            <field name="can_perform_netting" invisible="1"/>
                            <field name="is_netted" invisible="1"/>
                            <field name="is_settled" readonly="1"/>
                            <field name="can_modify" invisible="1"/>
                            <field name="fee_allocation_count" invisible="1"/>
                            <field name="has_fee_allocations" invisible="1"/>
                        </group>
                    </group>
                    
                    <!-- Summary Section -->
                    <group string="Settlement Summary" name="summary">
                        <group>
                            <field name="total_invoice_amount" readonly="1"/>
                            <field name="total_vendor_bills" readonly="1"/>
                        </group>
                        <group>
                            <field name="net_settlement_amount" readonly="1"/>
                            <field name="net_payout_amount" readonly="1" 
                                   invisible="vendor_bill_count == 0"/>
                        </group>
                    </group>
                    
                    <!-- New Workflow Information -->
                    <group string="New Workflow Process" name="workflow_info">
                        <div class="alert alert-info" role="alert">
                            <strong>Enhanced Workflow:</strong><br/>
                            ‚Ä¢ <strong>Settlement</strong> now only groups customer invoices (no deductions)<br/>
                            ‚Ä¢ <strong>Fees &amp; Taxes</strong> are recorded in separate vendor bills for proper documentation<br/>
                            ‚Ä¢ <strong>AR/AP Netting</strong> offsets settlement receivables against vendor bill payables<br/>
                            ‚Ä¢ <strong>Bank Reconciliation</strong> handles only the net remaining amount
                        </div>
                        <!-- Thai Localization Fields - moved here -->
                        <group invisible="not is_thai_localization_available">
                            <field name="is_thai_localization_available" invisible="1"/>
                            <field name="use_thai_wht" invisible="not is_thai_localization_available" readonly="not can_modify"/>
                            <field name="thai_income_tax_form" invisible="not use_thai_wht or not is_thai_localization_available" readonly="not can_modify"/>
                            <field name="thai_wht_income_type" invisible="not use_thai_wht or not is_thai_localization_available" readonly="not can_modify"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Invoices" name="invoices">
                            <field name="invoice_ids" nolabel="1">
                                <tree decoration-info="is_refund" decoration-bf="amount_residual &gt; 1000" decoration-danger="is_settled">
                                    <field name="name"/>
                                    <field name="partner_id"/>
                                    <field name="invoice_date"/>
                                    <field name="trade_channel"/>
                                    <field name="amount_total"/>
                                    <field name="amount_residual"/>
                                    <field name="is_refund" widget="boolean"/>
                                    <field name="is_settled" widget="boolean" string="Already Settled"/>
                                    <field name="state"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Vendor Bills" name="vendor_bills" invisible="state == 'draft'">
                            <div class="alert alert-info" role="alert" invisible="vendor_bill_count &gt; 0">
                                <strong>AR/AP Netting:</strong> Select vendor bills from the same marketplace partner to net against customer receivables. 
                                This will reduce the final payout amount and simplify bank reconciliation.
                            </div>
                            <field name="vendor_bill_ids" nolabel="1">
                                <tree>
                                    <field name="name"/>
                                    <field name="partner_id"/>
                                    <field name="invoice_date"/>
                                    <field name="amount_total"/>
                                    <field name="amount_residual"/>
                                    <field name="state"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Netting Details" name="netting" invisible="not is_netted">
                            <div class="alert alert-success" role="alert">
                                <strong>AR/AP Netting Completed:</strong> Customer receivables have been netted against vendor payables.
                                Only the net payout amount needs to be reconciled against your bank statement.
                            </div>
                            <group>
                                <group string="Amounts">
                                    <field name="total_invoice_amount" readonly="1" string="Customer Receivables"/>
                                    <field name="total_vendor_bills" readonly="1" string="Vendor Payables"/>
                                    <field name="net_payout_amount" readonly="1" string="Net Payout Amount"/>
                                </group>
                                <group string="Netting Information">
                                    <field name="netting_move_id" readonly="1"/>
                                    <field name="is_netted" readonly="1"/>
                                </group>
                            </group>
                        </page>
                        <page string="Fee Allocations" name="fee_allocations">
                            <div class="oe_button_box" name="fee_allocation_buttons">
                                <button name="action_view_fee_allocations" type="object" class="oe_stat_button" icon="fa-calculator">
                                    <field name="fee_allocation_count" widget="statinfo" string="Allocations"/>
                                </button>
                            </div>
                            
                            <div class="alert alert-info" role="alert" invisible="has_fee_allocations">
                                <strong>Fee Allocation:</strong> Generate allocations to distribute marketplace fees, VAT, and withholding tax 
                                across individual invoices for detailed profitability analysis and reporting. No GL impact.
                            </div>
                            
                            <group>
                                <group string="Allocation Settings">
                                    <field name="allocation_method"/>
                                    <field name="has_fee_allocations" readonly="1"/>
                                </group>
                                <group string="Actions">
                                    <button name="action_generate_fee_allocations" type="object" string="Generate Allocations" 
                                            class="btn-primary" invisible="has_fee_allocations"
                                            help="Create fee allocation records for all invoices"/>
                                    <button name="action_import_fee_allocations_csv" type="object" string="Import from CSV" 
                                            class="btn-primary" invisible="has_fee_allocations"
                                            help="Import exact allocation values from CSV file"/>
                                    <button name="action_recalculate_fee_allocations" type="object" string="Recalculate" 
                                            class="btn-secondary" invisible="not has_fee_allocations"
                                            help="Recalculate proportional allocations"/>
                                    <button name="action_import_fee_allocations_csv" type="object" string="Import CSV Updates" 
                                            class="btn-secondary" invisible="not has_fee_allocations"
                                            help="Import updates from CSV file"/>
                                    <button name="action_clear_fee_allocations" type="object" string="Clear Allocations" 
                                            class="btn-warning" invisible="not has_fee_allocations"
                                            confirm="Are you sure you want to delete all fee allocations?"
                                            help="Remove all fee allocation records"/>
                                </group>
                            </group>
                            
                            <field name="fee_allocation_ids" nolabel="1" invisible="not has_fee_allocations">
                                <tree editable="bottom" decoration-info="allocation_method=='proportional'" decoration-warning="allocation_method=='exact'" 
                                      sum_label="Totals:">
                                    <field name="invoice_number" readonly="1"/>
                                    <field name="invoice_partner_id" readonly="1"/>
                                    <field name="allocation_method"/>
                                    <field name="allocation_base_amount" readonly="1" sum="Total Base"/>
                                    <field name="allocation_percentage" widget="percentage" readonly="1"/>
                                    <field name="base_fee_alloc" sum="Total Fee"/>
                                    <field name="vat_input_alloc" sum="Total VAT"/>
                                    <field name="wht_alloc" sum="Total WHT"/>
                                    <field name="total_deductions_alloc" readonly="1" sum="Total Deductions"/>
                                    <field name="net_payout_alloc" readonly="1" sum="Net Payout"/>
                                    <button name="action_allocate_proportional" type="object" string="Recalc" 
                                            icon="fa-calculator" title="Recalculate proportional allocation"
                                            invisible="allocation_method != 'proportional'"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Thai Localization" name="thai_localization" invisible="not is_thai_localization_available">
                            <div class="alert alert-info" role="alert">
                                <strong>Thai Localization:</strong> This section provides integration with Thai tax modules 
                                for withholding tax certificates and Thai tax reporting compliance.
                            </div>
                            
                            <group string="Thai WHT Configuration">
                                <group>
                                    <field name="use_thai_wht"/>
                                    <field name="thai_income_tax_form" invisible="not use_thai_wht"/>
                                    <field name="thai_wht_income_type" invisible="not use_thai_wht"/>
                                </group>
                                <group>
                                    <field name="wht_cert_count" readonly="1"/>
                                    <button name="action_create_wht_certificate" type="object" string="Create WHT Certificate" 
                                            class="btn-primary" invisible="not use_thai_wht or state != 'posted' or vendor_bill_count == 0"
                                            help="Create Thai withholding tax certificate from vendor bills"/>
                                </group>
                            </group>
                            
                            <field name="wht_cert_data" nolabel="1" invisible="wht_cert_count == 0" readonly="1" widget="text"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Channel-specific actions -->
    <!-- Channel-specific actions were removed per request: only generic Marketplace menus remain -->
</odoo>
