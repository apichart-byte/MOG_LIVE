<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_picking_form_advance_accounting" model="ir.ui.view">
        <field name="name">stock.picking.form.advance.accounting</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="arch" type="xml">
            <!-- Add invisible field for computed purchase_order_id -->
            <field name="country_code" position="after">
                <field name="purchase_order_id" invisible="1"/>
            </field>
            
            <!-- Add smart buttons in the button box -->
            <xpath expr="//div[hasclass('oe_button_box')]" position="inside">
                <button type="object" 
                        name="action_view_advance_accruals" 
                        class="oe_stat_button" 
                        icon="fa-money"
                        invisible="not purchase_order_id">
                    <field name="advance_accrual_count" widget="statinfo" string="Advance Accruals"/>
                </button>
            </xpath>
            
            <!-- Add action buttons in a dedicated Advance Accounting tab -->
            <xpath expr="//notebook" position="inside">
                <page string="Advance Accounting" invisible="not purchase_order_id">
                    <group>
                        <group string="Advance Operations">
                            <button name="action_create_advance_accrual"
                                    type="object"
                                    string="Create Advance"
                                    class="btn-primary btn-lg"
                                    invisible="not purchase_order_id or state not in ['assigned', 'done']"
                                    help="Create advance accrual entry for this Purchase Order"/>
                                    
                            <button name="action_reverse_all_advance_accruals"
                                    type="object"
                                    string="Reverse All"
                                    class="btn-warning"
                                    invisible="not purchase_order_id or advance_accrual_count == 0"
                                    help="Reverse all advance accrual entries for this Purchase Order"/>
                        </group>
                    </group>
                </page>
            </xpath>
        </field>
    </record>
</odoo>
